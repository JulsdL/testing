translate_text_task:
  description: >
    Translate the following text into FALC using provided editorial and design rules.

    **CRITICAL REQUIREMENT: ABSOLUTE INFORMATION PRESERVATION**
    - Every fact, date, amount, condition, proper name, address, and obligation from the original text MUST appear in your simplified version
    - Do NOT delete, summarize, or alter any essential information
    - If information seems redundant, rephrase it differently to reinforce understanding instead of removing it
    - Ensure the entire provided document is processed and simplified
    - Reformulate for clarity and simplicity while maintaining message completeness
    - Make sure no information is duplicated or omitted

    **VERY IMPORTANT: You MUST consult and meticulously apply ALL rules from the 'Règles d'édition FALC' document (available in your knowledge base) for every sentence you write.**
    This includes specific instructions for sentence structure, vocabulary, numbers, dates, lists, complex structures (conditions, cause/effect, etc.), and forbidden phrases.
    Pay special attention to the rule: "Lorsqu'une phrase commence par 'si', transformer pour poser la condition sous forme de question puis répondre"

    **KEY STYLE AND CONTENT RULES TO FOLLOW:**
    - **No Summaries:** Absolutely do not add a summary or recap that would duplicate previous text at the end of the document. The translation must end after the last piece of information.
    - **Consistent Vocabulary (Isosemie):** Be extremely consistent with your choice of words. If you translate a term one way (e.g., "logement"), you must use that same word throughout the entire document. Do not use synonyms like "bail" or "appartement".
    - **Sentence Starters:** Do not start sentences with "Ou", "Alors", or "Donc". The only exception is the "Question? Alors..." pattern for conditions.
    - **No Subject Repetition:** Do not repeat the letter's subject in the first sentence. The first sentence should state the document's purpose directly.
    - **Positive Phrasing:** Always prefer positive sentences. For example, instead of "Qui peut vous aider si vous avez des questions ?", write "Vous avez des questions ?".
    - **Direct Phrasing for Lists:** When listing items like rules or obligations, write each item as a complete, self-sufficient sentence. Do NOT create redundant "label: description" pairs.
        - **BAD:** `Garder la carte: Vous devez garder votre carte d'accès aux soins « EVAM » sur vous en permanence.`
        - **GOOD:** `Vous devez garder votre carte d'accès aux soins « EVAM » sur vous en permanence.`

    **All output sentences must be grammatically correct and professional French, even when simplified.**

    1. First, consult the available icons list:
      {icon_list}

    2. Use only the icon keys listed above, in the format [[ICON:icon_key]].
      Do NOT use emojis or invent new keys.
      Do NOT add icons in header, recipient, subject or footer—only in body sections for alert / warning lines.

    3. **Acronyms**
      - Do **NOT** interpret or expand any acronym from the original text.
      - Keep all acronyms exactly as they appear (e.g. LAsi, LARA, etc.)—never invent meanings.

    4. **Addressing & Procedures**
      - Include any addressing information (e.g. “à envoyer au directeur de l'EVAM, adresse”) and all procedural instructions.

    5. **Legal Citations**
      - Retain all citations of articles de loi.
      - Place them together at the very end of the final body_section paragraph.

    6. **Do NOT produce any Markdown tables** (no pipes `|`, no `---` separators).
      Instead, whenever you have logistical data, emit each item as its own paragraph, for example:
      ```
      Quand?: …
      Où?: …
      Horaires: …
      Transport: …
      Règles: …
      ```
      And for multi-line schedules, each day-line must be its own paragraph immediately following the “Horaire:” paragraph.

      This ensures the table optimizer can detect and tabulate them.

    7. Use ReferenceModelRetriever to find a matching example, then rewrite in FALC following the rules — do not copy.

    **VERIFICATION CHECKLIST:**
    Before finalizing your translation, verify that:
    - All names, dates, amounts, and addresses from the original are present
    - No sentence are left in conditionnel or subjunctive mood, no "si" clauses without question format
    - All conditions and obligations are clearly stated
    - All procedural steps are included
    - The entire document has been processed
    - Nothing has been omitted or oversimplified to the point of information loss
    - There are no duplicated information
    - French syntax and grammar MUST BE profesionally correct

    **FINAL VERIFICATION STEP USING FALC CHECKLIST:**
    Before concluding, review your output against the 33 criteria in the 'Check-list de vérification' from the 'Règles d'édition FALC to Confirm that your text aligns with these criteria, especially regarding word choice, sentence structure, formatting and grammatical correctness.

    Text to translate:
    {original_text}

  expected_output: >
    Return a dictionary with keys:
      header, recipient, subject, body_sections, footer

    - header, recipient, footer may be null if not needed.
    - subject: the one-line subject.
    - body_sections: a list of paragraphs; logistical fields (Quand, Où, Horaire, Transport, Règles) must each be their own paragraph.
    - Only body_sections may contain [[ICON:…]] placeholders.

    Here's an example of a good tranlation result with the right text structure:
    """{
      "header": null,
      "recipient": "Madame",
      "subject": "Confirmation de votre participation au programme de formation et de pratique professionnelle - Session octobre 2019",
      "body_sections": [
        "Nous confirmons votre inscription au programme de formation et de pratique professionnelle en santé.",
        "Quand ?",
        "Mardi 15 octobre 2019 à 9h00.",
        "Où ?",
        "Route de Chavannes 33 à Lausanne, au 2ème étage, salle 202.",
        "Vous suivez des cours sur la santé, l'approche sociale et la vie domestique.",
        "Le premier jour, vous recevez plus d'informations sur la formation et le déroulement du programme.",
        "Nous sommes contents de vous rencontrer.",
        "Formation santé - Informations générales :",
        "La formation dure 6 mois à plein temps.",
        "Vous avez des horaires fixes :",
        "La formation théorique est de 22 heures par semaine.",
        "Lundi : de 8h30 à 12h30 et de 13h30 à 15h30.",
        "Mardi : de 8h30 à 12h30 et de 13h30 à 15h30.",
        "Jeudi : de 8h30 à 12h30 et de 13h30 à 15h30.",
        "Vendredi : de 8h30 à 12h30.",
        "Pour certains, un cours de français lié au métier a lieu le mercredi matin de 8h30 à 12h.",
        "Interventions :",
        "Les interventions pratiques sont au maximum 10 heures par semaine.",
        "Le mercredi toute la journée et le vendredi après-midi sont pour les aides à domicile.",
        "Les horaires sont irréguliers.",
        "Les participants doivent être disponibles et flexibles.",
        "Contrat :",
        "Une convention de participation pour toute la durée de la formation sera signée le premier jour.",
        "[[ICON:travail_contrat]] Votre présence aux cours est OBLIGATOIRE.",
        "[[ICON:attention_avertissement]] Ne prenez **pas** de rendez-vous médicaux, CAF ou autres pendant les heures de cours.",
        "Pause repas :",
        "Un espace pour les repas est disponible avec un micro-ondes.",
        "Vous pouvez prendre un repas au réfectoire pour un montant de CHF 3.50 ou 10 (CSIR, CRS).",
        "Un badge vous sera donné le premier jour contre une caution de CHF 10.",
        "Stage de fin de formation :",
        "Le stage dure 4 semaines dans un EMS ou institution similaire.",
        "Le stage est à plein temps avec des horaires variables.",
        "Les formatrices organisent le stage.",
        "Le stage est validé par une évaluation et un examen clinique.",
        "[[ICON:attention_avertissement]] Règles importantes :",
        "Votre présence aux cours est obligatoire.",
        "Vous ne devez **pas** prendre de rendez-vous pendant les heures de cours.",
        "Vous êtes souvent en retard ? Vous êtes absent sans excuse ? Vous allez payer une amende.",
        "",
        "| [[ICON:bases_legales]] | Art. 127 cc LARA |"
      ],
      "footer": null
    }""""

  agent: falc_translator

table_optimizer_task:
  description: >
    Review the FALC translator's `body_sections` and identify opportunities to restructure content into tables for improved clarity and readability, then define the table data.
    **VERY IMPORTANT: The final `body_sections` list you output MUST contain ALL original content that was NOT converted into a table, PLUS the `[[TABLE:key]]` placeholders for any tables you created. All items must be in their correct original relative order.**

    **CRITICAL RULE: Unified Table Creation from Questions**
    When you encounter a question in the text followed by one or more paragraphs that answer it, you MUST convert this block into a single, unified table structure.
    When transforming a content into a table, NEVER introduce conditional or subjunctive mood. Always rephrase conditions as direct questions followed by clear answers.
    **NEVER** introduce "si" clauses or conditional phrasing in the table content.
    You MUST use the text given by the FALC translator as-is, without altering the meaning or omitting any information.

    **Procedure:**
    1.  **Use the question as the `title` for the table.** This applies to ALL question-based tables, whether the answer is a single sentence or a list.
    2.  The table MUST be structured with a **single column**.
    3.  Each answer paragraph becomes a row in this single column.
    4.  You **MUST set `hide_column_headers: true`**. The title provides all the necessary context.
    5.  The original question and all answer paragraphs must be removed from the `body_sections` and replaced with a single `[[TABLE:key]]` placeholder.

    ---
    **Icon Handling for Single-Column Tables:**
    For each row you create, you MUST check if the sentence's content corresponds to one of the available icons. If it does, you **MUST prepend the `[[ICON:key]]` placeholder** to the beginning of the sentence within the cell. Use your judgment to add icons where they add clarity.

    *   **Available Icons:** {icon_list}

    ---
    **Example 1: Single Answer**
    *   **Initial Text:** `"Qui paie les lunettes ?", "L'EVAM paie les frais..."`
    *   **Correct Table Output:**

          "key": "paiement_lunettes",
          "title": "Qui paie les lunettes ?",
          "columns": [""],
          "rows": [
            ["[[ICON:payer_argent_facture]] L'EVAM paie les frais..."]
          ],
          "hide_column_headers": true


    **Example 2: List of Obligations**
    *   **Initial Text:** `"Quelles sont vos obligations ?", "Vous devez toujours garder votre carte...", "Vous devez montrer votre carte..."`
    *   **Correct Table Output:**

          "key": "obligations_lunettes",
          "title": "Quelles sont vos obligations ?",
          "columns": [""],
          "rows": [
            ["[[ICON:attention_avertissement]] Vous devez toujours garder votre carte..."],
            ["[[ICON:assurance_maladie]] Vous devez montrer votre carte..."]
          ],
          "hide_column_headers": true

    ---

     **1. Identify Content Suitable for Tables:**
      Actively look for various types of information that would benefit from a tabular presentation, such as:
      - **Comparisons:** Options, features, pros/cons.
      - **Lists of Conditions/Criteria:** Requirements, rules, eligibility points for a specific topic.
      - **Procedural Steps:** If steps have multiple components (e.g., step number, action, detail).
      - **Schedules or Timetables:** Events, times, locations.
      - **Contact Information Blocks:** Multiple contacts with names, roles, phone numbers, emails.
      - **Logistical Data:** The existing patterns for Meeting (Quand, Où, Horaire, etc.), Legal Rules, and Places tables are still valid, but you are not limited to them.
      - **Any data that naturally forms rows and columns of related information.**

      Here are some frequently used table structures to consider:

        • **Meeting Table** (“Détails de la réunion”):
          - Columns: ["Élément", "Détails"]
          - Example Rows: Quand, Où, Horaire, Transport, Règles

        • **Legal Rules Table** (“Règles légales”):
          - Columns: ["Article", "Description"]
          - Example rows for: Article, Règle

        • **Places Table** (“Liste des lieux”):
          - Columns: ["Information", "Valeur"]
          - Rows for: Contact, Adresse, Téléphone

        • **Schedule Table** (“Horaire hebdomadaire”):
          - Columns: ["Où", "Quand", "Détails"]
          - Rows for each day and time slot

        **DO not create empty rows**

     **2. Table Creation Process:**
      When you identify a block of text suitable for a table:
        a. **Gather all consecutive paragraphs** that form the data for the table.
        b. In `body_sections`, **replace that entire group of paragraphs** with a single `[[TABLE:your_unique_key]]` placeholder (e.g., `[[TABLE:comparison_options]]`, `[[TABLE:procedure_steps_payment]]`).
        c. In the `tables` output field (which should be a list of dictionaries), add a new dictionary for this table with the following structure:
          - `key`: The `your_unique_key` you used in the placeholder.
          - `title`: (Optional but Recommended) A concise and clear FALC title for the table (e.g., "Comparaison des options", "Étapes pour payer").
          - `columns`: A list of strings for the column headers. Choose clear, simple FALC headers (e.g., ["Option", "Avantage", "Inconvénient"], ["Étape", "Action à faire", "Explication"]).
          - `rows`: A list of lists, where each inner list represents a row and contains the cell values in order. Ensure the text within cells follows FALC guidelines (simple, clear, short sentences if needed).
          - `hide_column_headers`: (boolean, default: false) Set to `true` if the context makes headers redundant (e.g., for very simple key-value tables where the first column acts as a header, like the existing Meeting/Places tables).

    **3. Handling Existing Table Patterns (Meeting, Legal, Places, Schedules):**
      The specific column names and titles for "Détails de la réunion", "Règles légales", and "Liste des lieux" can still be used when that exact data is found. For these, `hide_column_headers` is typically `true` because the first column labels (Quand, Où, Article, Contact, etc.) act as headers.
      - **Meeting Table** (key e.g., `meeting_details`): title "Détails de la réunion", columns ["Information", "Détails"], hide_column_headers: true. Rows for Quand, Où, Horaire, Transport, Règles.
      - **Legal Rules Table** (key e.g., `legal_rules`): title "Règles légales", columns ["Référence", "Description"], hide_column_headers: true. Rows for Article, Règle.
      - **Places Table** (key e.g., `contact_places`): title "Liste des lieux", columns ["Information", "Valeur"], hide_column_headers: true. Rows for Contact, Adresse, Téléphone.
      - **Schedules** (key e.g., `schedule`): title "Horaire hebdomadaire", columns ["Où", "Quand" "Détails"], hide_column_headers: true. Rows for each day and time slot.
      *Ensure rows are only created if both label and value exist in the text.*

    **4. Reconstructing `body_sections` and Preserving All Content:**
    Your main task is to produce a new `body_sections` list and a `tables` list.
    To do this correctly and avoid data loss:
      a. Initialize an empty list for your new `body_sections` output.
      b. Iterate through the *input* `body_sections` list, paragraph by paragraph, keeping track of which paragraphs you are processing (e.g., by index).
      c. While iterating through the original `body_sections`:
          i. Check if the current paragraph (or a sequence of paragraphs starting at the current position) is identified to be transformed into a table based on your analysis in step 1, 2, and 3.
          ii. If YES (the content is for a table):
              1. Create the table data (key, title, columns, rows) and add it to your `tables` list.
              2. Add the single `[[TABLE:your_key]]` placeholder for that table to your new `body_sections` list.
              3. Advance your iteration in the original `body_sections` list past all the paragraphs that were incorporated into this table to avoid processing them again.
          iii. If NO (the current paragraph is NOT part of any content converted to a table):
              1. Append the original paragraph AS IS to your new `body_sections` list.
              2. Advance your iteration in the original `body_sections` list to the next paragraph.
      d. **Crucial for data integrity:** This iterative process ensures that all original textual content that isn't transformed into a table is preserved in the output `body_sections`, and that content transformed into tables is correctly replaced by a single placeholder. All content from the input `body_sections` must be accounted for in the output: either as a table placeholder or as preserved text.
      e. Remove any FALC translator's markdown table formatting (e.g., `|\n| --- | --- |\n|`) from the text *before* placing it into the table `rows` or if it's part of the paragraphs you are replacing/removing.

     **5. Icon Handling:**
    - Keep any `[[ICON:…]]` markers found in the text when you move that text into a table cell.
    - **Mandatory icons** in the first column for the *specific labels* of the Meeting/Places tables as previously defined (Quand, Où, Quoi, Horaire, Transport, Règles à respecter, Avertissement, Contact, Adresse, Téléphone). For other, more generic tables you create, use icons if they genuinely add clarity to a label in the first column, but it's not mandatory for all custom tables.

    Available icons:
    {icon_list}

    **Overall Goal:** Make the document more readable and understandable by intelligently using tables where appropriate, not just for a few fixed patterns. Prioritize clarity, FALC principles, and **complete information preservation** in table content and structure. All content from the input `body_sections` must be either in a created table or in the output `body_sections`.

  expected_output: >
    Return a dictionary with exactly:
      header, recipient, subject, body_sections, footer, tables

    - In `body_sections`, each detected block is replaced by `[[TABLE:<key>]]`.
    - No paragraph whose content appears in a table row may remain.
    - In `tables`, each row's first element begins with its `[[ICON:key]]` placeholder.
    - The “Règles” row's second-column entry must concatenate all rule paragraphs (with icons) into one cell.

    Here's a an example of a perfectly formated document:
    """{
      "header": null,
      "recipient": "Madame",
      "subject": "Confirmation de votre participation au programme de formation et de pratique professionnelle - Session octobre 2019",
      "body_sections": [
        "Nous confirmons votre inscription au programme de formation et de pratique professionnelle en santé.",
        "[[TABLE:meeting]]",
        "Vous suivez des cours sur la santé, l'approche sociale et la vie domestique.",
        "Le premier jour, vous recevez plus d'informations sur la formation et le déroulement du programme.",
        "Nous sommes contents de vous rencontrer.",
        "Formation santé - Informations générales :",
        "La formation dure 6 mois à plein temps.",
        "Vous avez des horaires fixes :",
        "[[TABLE:schedule]]",
        "Pour certains, un cours de français lié au métier a lieu le mercredi matin de 8h30 à 12h.",
        "Interventions :",
        "Les interventions pratiques sont au maximum 10 heures par semaine.",
        "Le mercredi toute la journée et le vendredi après-midi sont pour les aides à domicile.",
        "Les horaires sont irréguliers.",
        "Les participants doivent être disponibles et flexibles.",
        "Contrat :",
        "Une convention de participation pour toute la durée de la formation sera signée le premier jour.",
        "[[ICON:travail_contrat]] Votre présence aux cours est OBLIGATOIRE.",
        "[[ICON:attention_avertissement]] Veuillez ne pas prendre de rendez-vous médicaux, CAF ou autres pendant les heures de cours.",
        "Pause repas :",
        "Un espace pour les repas avec micro-ondes est à votre disposition.",
        "Vous pouvez prendre un repas au réfectoire pour CHF 3.50 ou CHF 10 (CSIR, CRS).",
        "Un badge vous sera remis le premier jour contre une caution de CHF 10.",
        "Stage de fin de formation :",
        "Le stage dure 4 semaines dans un EMS ou institution similaire.",
        "Le stage est à plein temps avec des horaires variables.",
        "Les formatrices organisent le stage.",
        "Le stage est validé par une évaluation et un examen clinique.",
        "[[TABLE:legal_rules]]"
      ],
      "footer": null,
      "tables": [
        {
          "key": "meeting",
          "title": "Détails de la réunion",
          "columns": ["Élément", "Détails"],
          "rows": [
            ["[[ICON:calendrier_heure_date]] Quand", "Mardi 15 octobre 2019 à 9h00."],
            ["[[ICON:localisation_ou_lieu_carte]] Où", "Route de Chavannes 33 à Lausanne, au 2ème étage, salle 202."]
          ],
          "hide_column_headers": true
        },
        {
          "key": "schedule",
          "title": "Horaire hebdomadaire",
          "columns": ["Élément", "Détails"],
          "rows": [
            ["[[ICON:heure_montre_horloge]] Horaire", "La formation théorique est de 22 heures par semaine.\nLundi : de 8h30 à 12h30 et de 13h30 à 15h30.\nMardi : de 8h30 à 12h30 et de 13h30 à 15h30.\nJeudi : de 8h30 à 12h30 et de 13h30 à 15h30.\nVendredi : de 8h30 à 12h30."]
          ],
          "hide_column_headers": true
        },
        {
          "key": "legal_rules",
          "title": "Règles légales",
          "columns": ["Article", "Description"],
          "rows": [
            ["[[ICON:respect_reglement]] Règles à respecter",
             "[[ICON:attention_avertissement]] Votre présence aux cours est obligatoire.\n[[ICON:attention_avertissement]] Vous ne devez **pas** prendre de rendez-vous pendant les heures de cours.\n[[ICON:attention_avertissement]] Vous êtes souvent en retard ? Vous êtes absent sans excuse ? Vous allez payer une amende."
            ],
            ["[[ICON:bases_legales]] Article", "Art. 127 cc LARA"]
          ],
          "hide_column_headers": true
        }
      ]
    """


  agent: table_optimizer

rewrite_original_doc_task:
  description: >
    Erase everything from paragraph index {replace_start} through {replace_end} (inclusive) in the original document,
    then insert the FALC translation (subject + body sections + tables) in that region.

    ***YOU MUST NOT*** modify the translations provided by the FALC translator.

    The following values will be passed to the writer tool:
    - header (optional)
    - recipient (optional)
    - subject
    - body_sections
    - tables (optional)
    - replace_start
    - replace_end
    - output_dir: {output_dir}

    Here's the original file path: {original_file}

  expected_output: >
    A .docx file rewritten in-place, saved as output/{session_id}/document_name_falc_TIMESTAMP.docx

  agent: falc_document_designer
